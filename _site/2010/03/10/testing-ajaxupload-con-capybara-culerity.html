<!DOCTYPE HTML>
<html>
<head>
  <title>Fernando Espinosa | Programador web freelance. Testing AjaxUpload con Capybara + Culerity</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/reset.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/style.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/pygments.css" />
  <meta name="description" content="Soy un programador web freelance, especializado en proyectos ágiles, ruby on rails, jquery, interfaces de usuario y usabilidad." />
  <meta name="keywords" content="programador, programador web, freelance, programador freelance, programador ruby on rails, freelance ruby on rails, ruby on rails, jquery, usability, html, css, css2, css3, javascript" />
  <link rel="canonical" href="http://www.ferdev.com" />
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="/atom.xml" />
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" />
</head>
<body id="blog">
  <header class="dark">
	<hgroup>
		<h1><a class="title" href="/" title="Home" rel="home"><img src="/images/logo.gif" alt="ferdev.com" width="59" height="59" />Ferdev</a></h1>
		<h3>Programador web freelance</h3>
	</hgroup>
</header>
<ul id="contact_icons">
  <li class="twitter"><a href="http://twitter.com/ferdev" title="Twitter - Ferdev">¡Sígueme!</a></li>
  <li class="mail"><a href="mailto:fer@ferdev.com" title="E-Mail - Ferdev">¡Envíame un e-mail!</a></li>
</ul>
  <nav>
	<ul id="menu">
		<li><a href="#blog" title="Portfolio">Blog</a></li>
		<li><a id="contact_button" href="#contact" title="Contacto">Contacto</a></li>
		<li><a href="#about" title="Sobre mí">Sobre mí</a></li>
		<li><a href="#portfolio" title="Portfolio">Portfolio</a></li>
	</ul>		
</nav>
  <section class="articles dark">
    <script type="text/javascript">
  var idcomments_acct = '9485e3d1ca4f30d30b14d9171a8b93b7';
  var idcomments_post_id;
  var idcomments_post_url;
</script>
<article>
	<h1>Testing AjaxUpload con Capybara + Culerity</h1>
	<span class="date">
		Mar 10, 2010
	</span>
	 <a rel="tag" href="/tag/rails/">rails</a>&nbsp; <a rel="tag" href="/tag/ruby/">ruby</a>&nbsp; <a rel="tag" href="/tag/capybara/">capybara</a>&nbsp; <a rel="tag" href="/tag/culerity/">culerity</a>&nbsp; <a rel="tag" href="/tag/testing/">testing</a>&nbsp; <a rel="tag" href="/tag/ajaxupload/">ajaxupload</a>&nbsp;

	<p>Llevo unos días probando <a href='http://github.com/jnicklas/capybara'>Capybara</a> después de los comentarios tan buenos que había escuchado de él en <a href='http://twitter.com/albertoperdomo/status/9643469318'>twitter</a> últimamente, especialmente de su integración con <a href='http://github.com/langalex/culerity'>Culerity</a>. Los hados además trataban de decirme algo porque la última <a href='http://github.com/porras/madrid-rb-feb-2010'>charla</a> de <a href='http://twitter.com/madridrb'>madridrb</a> que dio <a href='http://twitter.com/porras'>@porras</a> versaba sobre esto mismo (y <a href='http://github.com/cavalle/steak'>Steak</a>, que también estoy probando y me está gustando mucho). Por cierto que debería haber ido a la charla (pero no pude :-() porque seguro que me hubiese ahorrado muchos de los problemas que me encontré.</p>

<p>Los primeros vinieron con la instalación. Culerity es un recubrimiento (que poco me gusta esta palabra) de <a href='http://github.com/jarib/celerity'>Celerity</a>, que a su vez es otro recubrimiento de <a href='http://htmlunit.sourceforge.net/'>HtmlUnit</a>, un navegador web sin interfaz gráfico programado en Java. Y debido a esto, necesitas Jruby para instalar la gema de Celerity. Pues bien, rvm y todo este tinglado no se llevan demasiado bien. Y aunque hay un <a href='http://rvm.beginrescueend.com/integration/culerty/'>hack</a> para salir al paso, a mi no me valía del todo (a parte que no me gustaba mucho que digamos) porque yo no estaba usando Cucumber sino Steak (requisito para que funcione el Hack). Al final conseguí hacerlo funcionar instalando Jruby mediante Macports. No sé si me dará problemas en el futuro, pero hasta que Culerity y rvm se lleven mejor, me gusta más esta solución que andar cambiando variables de entorno en cada test.</p>

<p>La aplicación con la que estaba haciendo las pruebas tiene una carga de javascript muy alta, y los primeros problemas que me dieron los tests lo achacaba a esto. &#8220;Demasiado javascript&#8221;, pensaba para mis adentros cuando al testear una petición ajax me daba un error con la respuesta en formato JSON. Dándole vueltas y más vueltas, a punto de desinstalarlo todo porque no conseguía solucionarlo, di con la solución no recuerdo muy bien dónde: la última versión de Celerity (0.7.9) usaba una versión de HtmlUnit con algunos bugs, y recomendaban instalar la versión <strong>0.7.4</strong>. Pues mano de santo oiga :-)</p>

<p>Y llegamos al quid de la cuestión: probar <a href='http://valums.com/ajax-upload/'>AjaxUpload</a> con Capybara + Culerity. Me ha costado un par de días hacerlo funcionar, y en realidad ha sido una tontería. No hacía falta más que detenerse un poco a pensar como funciona AjaxUpload por dentro.</p>

<p>AjaxUpload es un hack para simular una subida asíncrona de un archivo al servidor de nuestra página web. Para ello, se vale de los siguientes pasos:</p>

<ol>
<li>
<p>Se asocia al elemento de la página web que tú hayas definido (un enlace o un botón, por ejemplo).</p>
</li>

<li>
<p>Cuando se dispara el evento &#8220;mouseover&#8221; sobre ese elemento, crea un div transparente de las mismas dimensiones que el elemento y lo sitúa por encima de él. Cuando el usuario intente pulsar el elemento, será este div en realidad el que se vea pulsado.</p>
</li>

<li>
<p>Cuando el usuario hace click en el div, se genera el elemento input file y se abre el diálogo de selección de archivo.</p>
</li>

<li>
<p>En cuanto el usuario selecciona el fichero, AjaxUpload crea un formulario, le agrega el input file del paso anterior, y crea un iframe. Este iframe, será el &#8220;target&#8221; del formulario recien creado.</p>
</li>

<li>
<p>AjaxUpload envía el formulario (que hará la subida del fichero a través del iframe) y fin del proceso.</p>

<p>Mi problema venía con el diálogo de selección. No veía cómo conseguir seleccionar el archivo y pulsar el botón &#8220;Aceptar&#8221; del diálogo de selección. Sabía que la clase <em>Celerity::FileField</em> contaba con el método <em>Set</em>, con el que podía pasarle la ruta de un archivo&#8230; Pero no sé por qué me dio por pensar que si el diálogo estaba abierto, no funcionaría. Hasta que lo probé, y me di cuenta que Celerity establece la ruta del archivo y cierra la ventana de diálogo él solito. Así que, problema resuelto.</p>
</li>
</ol>

<p>Aquí va un pequeño trozo de código de como quedaría montado. He sacado los selectores principales a variables para que se entienda mejor. Ah! También decir que yo tengo configurado Capybara para que por defecto use selectores css :-)</p>
<div class='highlight'><pre><code class='ruby'><span class='c1'># selector del botón asociado a AjaxUpload</span>
<span class='n'>button_selector</span> <span class='o'>=</span> <span class='s1'>&#39;button#upload&#39;</span>
<span class='c1'># selector del div que contendrá al input file. Se posicionará justo encima de button_selector</span>
<span class='n'>div_selector</span> <span class='o'>=</span> <span class='s1'>&#39;div.ajaxupload_container&#39;</span>
<span class='c1'># selector del input file</span>
<span class='n'>input_selector</span> <span class='o'>=</span> <span class='s1'>&#39;div.ajaxupload_container input.ajaxupload&#39;</span>
<span class='c1'># ruta al archivo a subir</span>
<span class='n'>file_path</span> <span class='o'>=</span> <span class='s1'>&#39;image.jpg&#39;</span>

<span class='c1'># Simulamos el evento &#39;mouseover&#39; sobre el botón original asociado a AjaxUpload</span>
<span class='n'>find</span><span class='p'>(</span><span class='n'>button_selector</span><span class='p'>)</span><span class='o'>.</span><span class='n'>trigger</span><span class='p'>(</span><span class='ss'>:mouseover</span><span class='p'>)</span>

<span class='c1'># Comprobamos que se haya creado el div de AjaxUpload</span>
<span class='n'>page</span><span class='o'>.</span><span class='n'>should</span> <span class='n'>have_css</span><span class='p'>(</span><span class='n'>div_selector</span><span class='p'>)</span>

<span class='c1'># Hacemos click en el div para disparar la creación del input file</span>
<span class='n'>find</span><span class='p'>(</span><span class='n'>div_selector</span><span class='p'>)</span><span class='o'>.</span><span class='n'>click</span>

<span class='c1'># El input file debería haberse creado</span>
<span class='n'>page</span><span class='o'>.</span><span class='n'>should</span> <span class='n'>have_css</span><span class='p'>(</span><span class='n'>input_selector</span><span class='p'>)</span>

<span class='c1'># Le pasamos la ruta de archivo al input file</span>
<span class='n'>find</span><span class='p'>(</span><span class='n'>input_selector</span><span class='p'>)</span><span class='o'>.</span><span class='n'>set</span><span class='p'>(</span><span class='n'>file_path</span><span class='p'>)</span>
</code></pre>
</div>
<p>Y ya está! Una aclaración: he modificado AjaxUpload para que asigne una clase al div y al input file que crea y sea más sencillo seleccionarlos, ya que por defecto no les asigna identificador ni clases de ningún tipo.</p>
	
</article>
<div class="comments">
  <span id="IDCommentsPostTitle" style="display:none"></span>
  <script type='text/javascript' src='http://www.intensedebate.com/js/genericCommentWrapperV2.js' charset='utf-8'></script>
</div>
  </section>
  <section id="contact" class="light">
    <div class="content">
	<h1 id="contact_me!">¡Contáctame!</h1>
	<p>No dudes en ponerte en contacto conmigo para cualquier cosa que puedas necesitar.</p>
	<ul>
		<li class="mail">Escríbeme a mi email, <a href="mailto:fer@ferdev.com"><strong>fer@ferdev.com</strong></a>.</li>
		<li class="twitter"><a href="http://twitter.com/ferdev"><strong>Sígueme</strong></a> en twitter.</li>
		<li class="facebook">O quizá eres más de <a href="http://www.facebook.com/fernando.espinosa">Facebook</a>...</li>
		<li class="linkedin">Mi perfil en <a href="http://es.linkedin.com/in/fernandoespinosajimenez"><strong>Linked In</strong></a>.</li>
		<li class="xing">Y en <a href="http://www.xing.com/profile/Fernando_EspinosaJimenez"><strong>Xing</strong></a>.</li>
	</ul>
</div>
  </section>
  <section id="about" class="dark">
    <div class="content">
	<h1 id="sobre_mi">Sobre mí.</h1>

	<h2 id="quien_soy">¿Quién soy?</h2>

	<p>Me llamo Fernando Espinosa, un tío de Madrid apasionado con el desarrollo web, <a href="http://rubyonrails.org/" title="Ruby on Rails">Ruby on Rails</a> y las <a href="http://en.wikipedia.org/wiki/Outside-in_software_development" title="Outside-in development">metodologías ágiles.</a></p>

	<h2 id="de_donde_vengo">¿De dónde vengo?</h2>

	<p>Mi primer contacto con el mundo de la programación vino cuando era solo un niño, de manos de un Amstrad CPC-6128 y un libro de Basic. A partir de ahí, pasé por lenguajes como Logo, Pascal, Fortran, C, Javascript, php, Java, C# y Ruby. He tenido la suerte de trabajar durante muchos años en algunas de las más importantes empresas del sector, como Soluziona o <a href="http://www.indra.es" title="Indra">Indra</a> entre otras. Puedes ver mi curriculum en <a href="http://www.xing.com/profile/Fernando_EspinosaJimenez" title="Fernando Espinosa Jiménez"><img src="/images/icons/social/xing.png" alt="Xing - Fernando Espinosa" /></a><a href="http://www.xing.com/profile/Fernando_EspinosaJimenez" title="Fernando Espinosa Jiménez">Xing</a> o <a href="http://es.linkedin.com/in/fernandoespinosajimenez" title="Fernando Espinosa Jiménez"><img src="/images/icons/social/linkedin.png" alt="Linked In - Fernando Espinosa" /></a><a href="http://es.linkedin.com/in/fernandoespinosajimenez" title="Fernando Espinosa Jiménez">Linkedin</a>.</p>

	<h2 id="que_es_lo_que_hago">¿Qué es lo que hago?</h2>

	<p>Desarrollo aplicaciones web, poniendo todos mis esfuerzos en crear aplicaciones usables, con interfaces de usuario limpios y atractivos.</p>

	<h2 id="como_lo_hago">¿Cómo lo hago?</h2>

	<p>Con la ayuda de <a href="http://es.wikipedia.org/wiki/Desarrollo_ágil_de_software">metodologías ágiles</a>, prototipando desde el inicio del desarrollo, y manteniendo una comunicación continua con mis clientes.</p>

	<h2 id="que_herramientas_uso">¿Qué herramientas uso?</h2>

	<p>Estas son con las que me siento más cómodo:</p>

	<ul>
  	<li><a href="http://rubyonrails.org/">Ruby on Rails</a></li>
  	<li><a href="http://jquery.com/">jQuery</a></li>
  	<li>HTML</li>
  	<li>CSS2 and CSS3</li>
  	<li>Mac OSX o Gentoo</li>
  	<li><a href="http://git-scm.com/" title="Git">Git</a></li>
  	<li><a href="http://pivotaltracker.com/" title="Pivotal tracker">Pivotal Tracker</a></li>
	</ul>

	<p>Lo siento, pero no estoy interesado en proyectos en Java, .NET o php ;-)</p>

	<h2 id="contratarme">Contratarme.</h2>

	<p>¿Necesitas un programador web freelance y mi perfil te ha interesado?</p>
	<p><a href="#contact">Cuéntame</a> las necesidades de tu proyecto y me pondré inmediatamente en contacto contigo para darte un presupuesto detallado.</p>

</div>
  </section>
  <section id="portfolio" class="light">
    <div class="content">
  <h1 id="my_portfolio.">Mi portfolio.</h1>
  <p>
    A continuación, una lista de los proyectos en los que he estado trabajando últimamente.
  </p>
  <p>
    También puedes ver mi cuenta de <a href="http://github.com/Ferdev" title="github.com de Fernando Espinosa" class="external">github.com</a>, algunos de estos proyectos están ahí.
  </p>
  <ul id="portfolio_projects">
    <li class="project">
      <a href="http://www.loovrs.com" title="loovrs.com" class="external"><img src="/images/portfolio/loovrs.jpg" alt="Loovrs"/></a>
      <ul class="project_data">
        <li class="title">Loovrs.com</li>
        <li class="year">2008</li>
        <li><a href="http://www.loovrs.com" title="loovrs.com" class="external">http://www.loovrs.com</a></li>
        <li>Desarrollo íntegro de un portal de dating utilizando Ruby on Rails.</li>
        <li>
          Tecnologías empleadas:
          <ul>
            <li>Back-end: Ruby on Rails v2.3.8, mysql.</li>
            <li>Front-end: xhtml strict, css2/css3, jQuery.</li>
            <li>Servidor apache 2.2 + <a href="http://www.modrails.com/" title="Passenger" class="external">Passenger</a>.</li>
            <li>Despliegues con <a href="http://www.capistranorb.com/" title="Capistrano" class="external">capistrano</a>.</li>
            <li>Servidor comet <a href="http://orbited.org/" title="Orbited" class="external">Orbited</a>.</li>
            <li>Detección de rostros empleando <a href="http://sourceforge.net/projects/opencvlibrary/" title="OpenCV" class="external">OpenCV</a>.</li>
            <li><a href="http://es.wikipedia.org/wiki/Desarrollo_guiado_por_pruebas" title="TDD" class="external">TDD</a>.</li>
          </ul>
        </li>
      </ul>
    </li>
    <li class="project">
      <img src="/images/portfolio/ferdev.wordpress.jpg" alt="FerDev"/>
      <ul class="project_data">
        <li class="title">FerDev.com</li>
        <li class="year">2009</li>
        <li>Desarrollo de un tema de wordpress para la versión anterior de este blog.</li>
        <li>
          Tecnologías empleadas:
          <ul>
            <li>Desarrollado empleando el framework <a href="http://carringtontheme.com/" title="Carrington Theme">Carrington Theme</a>.</li>
            <li>Back-end: Carrington Jam, wordpress, php.</li>
            <li>Front-end: xhtml strict, css2/css3, jQuery</li>
          </ul>
        </li>
      </ul>
    </li>
    <li class="project">
      <a href="http://ferdev.com" title="ferdev.com" class="external"><img src="/images/portfolio/ferdev.jekyll.jpg" alt="FerDev"/></a>
      <ul class="project_data">
        <li class="title">FerDev.com</li>
        <li class="year">2010</li>
        <li><a href="http://ferdev.com" title="ferdev.com" class="external">http://ferdev.com</a></li>
        <li>Migración y rediseño del antiguo blog en wordpress, utilizando el generador de sitios estáticos <a href="http://jekyllrb.com/" title="Jekyll" class="external">Jekyll</a></li>
        <li><a href="http://github.com/Ferdev/Ferdev" title="Código fuente de ferdev.com" class="external">Código fuente</a>.</li>
        <li>
          Tecnologías empleadas:
          <ul>
            <li>Back-end: <a href="http://jekyllrb.com/" title="Jekyll" class="external">Jekyll</a>, <a href="http://www.liquidmarkup.org/" title="Liquid template system" class="external">Liquid</a>, ruby.</li>
            <li>Front-end: html5, css2/css3, jQuery.</li>
          </ul>
        </li>
      </ul>
    </li>
    <li class="project">
      <a href="http://petswaiting.com" title="petswaiting.com" class="external"><img src="/images/portfolio/petswaiting.jpg" alt="PetsWaiting"/></a>
      <ul class="project_data">
        <li class="title">PetsWaiting.com</li>
        <li class="year">2010</li>
        <li><a href="http://petswaiting.com" title="petswaiting.com" class="external">http://petswaiting.com</a></li>
        <li>Desarrollo íntegro de una página web de adopción de animales con Ruby on Rails 3.</li>
        <li><a href="http://github.com/Ferdev/Pets-Waiting" title="Código fuente de petswaiting.com" class="external">Código fuente</a>.</li>
        <li>
          Tecnologías empleadas:
          <ul>
            <li>Back-end: Ruby on Rails v3.0.0, PostgreSQL.</li>
            <li>Front-end: html5, css2/css3, jQuery.</li>
            <li>Servidor Nginx + <a href="http://www.modrails.com/" title="Passenger" class="external">Passenger</a>.</li>
            <li>Despliegues con <a href="http://www.capistranorb.com/" title="Capistrano" class="external">capistrano</a>.</li>
            <li>Tests de aceptación usando <a href="http://github.com/cavalle/steak" title="Steak" class="external">Steak</a> y <a href="http://github.com/jnicklas/capybara" title="Capybara" class="external">Capybara</a>.</li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</div>

  </section>
  <footer id="footer" class="dark">
    <div class="content">
	<ul>
		<li>Diseñado por <a href="/" title="ferdev.com">ferdev.com</a>.</li>
		<li>'Social icons' por <a href="http://www.komodomedia.com/" title="Komodo Media">Komodo Media</a>.</li>
		<li><a href="http://github.com/ferdev/ferdev">Código fuente</a>.</li>
	</ul>
	<span>Copyright © 2010 Fernando Espinosa</span>
</div>
  </footer>
  <script type="text/javascript" src="http://use.typekit.com/ftm1uau.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
<script src="/javascripts/lib/preload_images.js" type="text/javascript" charset="utf-8"></script>
<script src="/javascripts/lib/jquery.easing.js" type="text/javascript" charset="utf-8"></script>
<script src="/javascripts/ferdev.init.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
	var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
	document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
	try {
		var pageTracker = _gat._getTracker("UA-6392398-3");
		pageTracker._trackPageview();
	} catch(err) {}
</script>
<script src="http://static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">clicky.init(228737);</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="http://in.getclicky.com/228737ns.gif" /></p></noscript>
</body>
</html>